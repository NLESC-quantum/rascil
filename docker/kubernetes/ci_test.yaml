.k8s-test:
  tags:
    - k8srunner
  image: $SKA_K8S_TOOLS_DEPLOY_IMAGE
  variables:
    SERVICE_ACCOUNT: ci-svc-$CI_PROJECT_NAME-$CI_COMMIT_BRANCH
    NAMESPACE: ci-$CI_PROJECT_NAME-$CI_COMMIT_BRANCH
    RELEASE: test
  rules:
    - if: '$CI_COMMIT_TAG'

# Only run it on commit tag and after the newest docker images have been released
cluster-test:
  extends: .k8s-test
  stage: test_k8s
  before_script:
    - apt-get -y update
    - apt-get install -y gettext-base --no-install-recommends
    - pip install pytest kubernetes  # needed for make test_k8s
    - make namespace
    - make pvc
    - make helm_repo
    - make install_chart
  script:
    - kubectl get pods,pvc -n ${NAMESPACE}
    - make test_k8s
    - make test_k8s_jupyter
  after_script:
    - make clean_up_k8s
  environment:
    name: test/$CI_COMMIT_REF_NAME
    kubernetes:
      namespace: $NAMESPACE
