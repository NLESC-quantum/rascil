image: "python:3.7"

variables:
  MPLBACKEND: "agg"

workflow:
  rules:
    - if: $CI_MERGE_REQUEST_ID
    - if: $CI_COMMIT_BRANCH
    - if: $CI_COMMIT_REF_NAME == "master" && $CI_COMMIT_TAG != ""

stages:
  - test
  - build
  - publish

unittests:
  stage: test
  before_script:
    - apt-get update
    - apt-get -y install rsync ca-certificates pybind11-dev
    - pip3 install -r requirements.txt
    - git clone https://gitlab.mpcdf.mpg.de/ift/nifty_gridder.git
    - cd nifty_gridder
    - pip3 install .
    - cd ..
    - mkdir -p test_results
    - mkdir -p /usr/share/casacore/data/
    - rsync -avz rsync://casa-rsync.nrao.edu/casa-data/geodetic /usr/share/casacore/data/
  script:
    - pip install pytest pytest-xdist pytest-cov
    - HOME=`pwd` py.test tests/workflows/test*rsexecute.py --verbose --cov=rascil --cov-report=html:coverage --durations=30 --forked
    - HOME=`pwd` py.test -n 4 tests/data_models tests/processing_components tests/workflows/test*serial.py --verbose --cov=rascil --cov-report=html:coverage --cov-append --durations=30 --forked
  artifacts:
    paths:
      - coverage
    expire_in: 1 week

docs:
  stage: build
  before_script:
    - apt-get update
    - apt-get -y install pandoc rsync
    - pip install -r requirements.txt -r requirements-docs.txt
    - mkdir -p docs/build/html
    - mkdir -p test_results
    - mkdir -p /usr/share/casacore/data/
    - rsync -avz rsync://casa-rsync.nrao.edu/casa-data/geodetic /usr/share/casacore/data/
  script:
    - PYTHONPATH=`pwd` HOME=`pwd` make -k -C docs/src html
  after_script:
    - mv docs/build/html html
  artifacts:
    paths:
      - html/
    expire_in: 1 week

data:
  stage: build
  script:
    - tar -zcf rascil_data.tgz data
  artifacts:
    paths:
      - rascil_data.tgz
    expire_in: 6 months
  only:
    - master

publish_to_nexus:
  stage: publish
  tags:
    - docker-executor
  variables:
    TWINE_USERNAME: $TWINE_USERNAME
    TWINE_PASSWORD: $TWINE_PASSWORD
  script:
    - pip install setuptools
    - python setup.py egg_info -b+$CI_COMMIT_SHORT_SHA sdist bdist_wheel # --universal option to used for pure python packages
    - pip3 install twine
    - twine upload --repository-url $PYPI_REPOSITORY_URL dist/*
#  only:
#    variables:
#       - $CI_COMMIT_MESSAGE =~ /^.+$/ # Confirm tag message exists
#       - $CI_COMMIT_TAG =~ /^((([0-9]+)\.([0-9]+)\.([0-9]+)(?:-([0-9a-zA-Z-]+(?:\.[0-9a-zA-Z-]+)*))?)(?:\+([0-9a-zA-Z-]+(?:\.[0-9a-zA-Z-]+)*))?)$/ # Confirm semantic versioning of tag
  only:
    - tags

staging: # Start the construction of dockers files in rascil-docker
  stage: publish
  trigger: ska-telescope/rascil-docker
  only:
    - master

pages:
  stage: publish
  dependencies:
    - docs
    - unittests
    - data
  script:
    - mv html public
    - mv rascil_data.tgz public
    - mv coverage/ public/coverage
  artifacts:
    paths:
      - public
      - public/coverage
    expire_in: 1 month
  only:
    - master
