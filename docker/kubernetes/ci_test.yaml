.k8s-test:
  tags:
    - k8srunner
  image: $SKA_K8S_TOOLS_DEPLOY_IMAGE
  variables:
    SERVICE_ACCOUNT: ci-svc-$CI_PROJECT_NAME-$CI_COMMIT_BRANCH
    NAMESPACE: ci-$CI_PROJECT_NAME-$CI_COMMIT_BRANCH
    RELEASE: test
# TODO: when should this run once rascil-notebook is up-to-date? need to see how long it takes
  rules:
    - if: '$CI_PIPELINE_SOURCE != "schedule" && ($CI_COMMIT_TAG == "" || $CI_COMMIT_TAG == null)'
# It shouldn't run for now because rascil-notebook:0.3.0 fails the deployment (need to release a new one)
#  when: manual

cluster-test:
  extends: .k8s-test
  stage: test
  before_script:
    - apt-get -y update
    - apt-get install -y gettext-base #curl ca-certificates --no-install-recommends
    - cd docker
    - make namespace
#    - | # create a temporary persistent volume claim
#      cat <<EOF | kubectl -n ${NAMESPACE} create -f -
#      {
#        "apiVersion": "v1",
#        "kind": "PersistentVolumeClaim",
#        "metadata": {
#          "name": "pvc-rascil-cip"
#        },
#        "spec": {
#          "storageClassName": "nfss1",
#          "accessModes": [
#              "ReadWriteMany"
#          ],
#          "resources": {
#            "requests": {
#              "storage": "5Gi"
#            }
#          }
#        }
#      }
#      EOF
    - make pvc
    - make install_chart
  script:
    - kubectl get pods,pvc -n ${NAMESPACE}
  after_script:
    - make clean_up_k8s
  environment:
    name: test/$CI_COMMIT_REF_NAME
    kubernetes:
      namespace: $NAMESPACE
